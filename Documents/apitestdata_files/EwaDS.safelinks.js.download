(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[63],{1651:function(u,D,b){function a(F){var K=T.call(this)||this;K.$=F;K.Eb();return K}function c(F){switch(F){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}}function d(F){switch(F){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}}function e(F,K,J,O,N,H){var Q=this;O=void 0===O?!1:O;N=void 0===N?null:N;H=void 0===H?null:H;this.tDa=this.sDa=
0;this.Syb=this.zSb=!1;this.Iqa=null;this.aWa=!0;this.aWb=null;n.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.ib=F;this.Pg=K;this.oQb=J;e.qh=H;this.Ayg=O?this.ib.Wa("SafeLinksHandlerWebServiceBase"):this.ib.Wa("WebServiceBase");this.iyg=this.ib.Wa("SafeLinksHashedUserId");this.LXj=this.ib.Wa("SafeLinksWorkloadIdHeaderValue");this.WTb=this.ib.kd("SafeLinksMaxGetPolicyBootRetries",2);this.XTb=this.ib.kd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.eTb=this.isSafeLinksEnabledForUser();
this.dTb=this.Vli();n.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.eTb,this.dTb);if(this.eTb&&this.dTb){K=(F=this.i3a())?F.IsSafeLinksEnabled.toLowerCase():"";J=this.Wod();n.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",K,J);var ca=!F||"unknown"===K||F.WasServiceDown||J,X=y.a.Fr();X&&(X.set("shouldGetSafeLinksDataFromServer",ca.toString()),X.set("isSafeLinksEnabledCacheValue",K.toString()));
this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&N?(this.aWa=!1,N.execute(function(Z){Z.isFeatureEnabled("MsoUrlreputation",!0).then(function(ea){Q.aWa=ea;X.set("isUserLicensedForSafeLinks",Q.aWa.toString());B.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",X);Q.aWa&&ca&&Q.Nbc(!0);return null})})):(B.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",X),ca&&this.Nbc(!0))}}function k(F,K,J,O){this.ib=F;this.Pg=K;this.hpg=
J;k.qh=O}function l(F,K){this.lzc=F;this.stopwatch=K}function m(F,K,J,O,N,H){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=F;this.WebAffinitizedUrl=K;this.PolicyCookie=J;this.PolicyCookieTTL=O;this.WasServiceDown=N;this.AffinitizedUrl=H}b.r(D);var f=b(11);u=b(0);var w=b(4);D=b(232);var n=b(15),z=b(83);Object(u.a)(m,"SafeLinksData",null,[]);Object(u.a)(l,"SafeLinksGetUrlReputationRequestData",
null,[]);var r=b(41),v=b(39);k.prototype.rBa=function(F,K,J){try{var O=null;k.qh&&(O=k.qh.sc("WebServiceCall","SafeLinksGetUrlReputation"));var N=new l(K,O);O={};O.AffinitizedUrl=F;O.TargetUrl=K;O.PolicyCookie=J;var H=r.c(O);this.Pg.Yl(this.hpg,2,H,null,!1,2,Object(z.a)(this,this.uMi,"onGetUrlReputationSuccessCallback"),Object(z.a)(this,this.tMi,"onGetUrlReputationFailureCallback"),N,void 0,void 0,3E3,3E3,"36");return!0}catch(Q){n.ULS.sendTraceTag(588788033,378,10,Q.message)}return!1};k.prototype.uMi=
function(F){var K="OnGetUrlReputationSuccessCallback: ",J=10,O=F.data.state;try{var N=r.b(F.data.Ud).reputationResults[0],H=N.navigateUrl.length,Q=O.lzc.length,ca=N.navigateUrl===O.lzc;N.navigateUrl&&0<N.navigateUrl.length&&(O.lzc=N.navigateUrl);K+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",F.data.httpStatus,N.verdict,Q.toString(),H.toString(),ca.toString());J=50}catch(X){K+=String.format("Exception {0}",X.message)}this.M4e(O,
K,J)};k.prototype.tMi=function(F){var K="OnGetUrlReputationFailureCallback: ",J=F.data.state;try{K+=String.format("HttpStatus {0}",F.data.httpStatus)}catch(O){K+=String.format("Exception {0}",O.message)}this.M4e(J,K,10)};k.prototype.M4e=function(F,K,J){F.stopwatch&&(F.stopwatch.stop(),F.stopwatch=null);n.ULS.sendTraceTag(588788034,378,J,K);v.a.Ze(F.lzc,void 0,"noopener,noreferrer","SafeLinksNav")};k.qh=null;Object(u.a)(k,"SafeLinksNavigationHelper",null,[]);var A;(function(F){F[F.enabledByPolicy=
0]="enabledByPolicy";F[F.disabledByPolicy=1]="disabledByPolicy";F[F.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";F[F.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(A||(A={}));Object(u.b)("SafeLinksNavigationState",A);var B=b(99),y=b(136),x=b(1027),C=b(262),G=b(247),E=b(897),I=b(25),U=b(178),M=b(190);e.prototype.rBa=function(F){if(!F)return n.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var K=this.wii(F);n.ULS.sendTraceTag(594830615,
378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",K,this.eTb,this.dTb,this.aWa);if(!(K&&this.eTb&&this.dTb&&this.aWa))return!1;var J=this.oyj();K=J.state;J=J.returnValue;n.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",A[K]);var O=y.a.Fr();O&&O.set("SafeLinksNavigationState",A[K]);B.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",
O);if(!J)return 2!==K&&3!==K||B.Health.instance.recordKpiFailure("SafeLinksNavigations",A[K],!1,!0,null),!1;n.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.wyj())return this.Wod()?!1:this.yCi.rBa(this.BHh(),F,this.l0e());if(!this.Wod())return this.V$f(F),!0;this.Iqa=F;n.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.Syb=!1;this.Nbc();return!0};e.prototype.wii=function(F){F=F.toLowerCase();var K=this.ib.gw("SafeLinksUnsupportedProtocols");
if(K)for(var J=0;J<K.length;J++)if(F.startsWith(K[J]))return!1;return!0};e.prototype.Nbc=function(F){F=void 0===F?!1:F;var K=y.a.Fr();K&&K.set("isOnBootRequest",F.toString());B.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",K);B.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",K);K=this.D2c("SafeLinksGetPolicy");this.Pg.Yl(this.PTh,1,null,null,!0,2,Object(z.a)(this,this.jWh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(z.a)(this,
this.iWh,"getSafeLinksDataFromServer_OnFailureCallback"),K,void 0,void 0,void 0,void 0,"23");this.Syb=F;this.zSb=!0;F?this.sDa++:this.tDa++};e.prototype.jWh=function(F){var K=G.a.ADi,J="";try{this.zSb=this.Syb=!1;var O=this.vyc(F.data.state).returnValue,N=Object.assign(new M.a,{durationMs:O});B.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",N);n.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",F.data.httpStatus,
F.data.Ud.length,O);if(F.data.httpStatus!==G.a.TO)J="Unexpected httpStatus: "+F.data.httpStatus.toString();else{O=null;try{O=r.b(F.data.Ud)}catch(qa){J="Exception:"+qa.toString()+" deserializing response";return}if(O){var H=O.IsSafeLinksEnabled;if(void 0===H||null===H||0>=H.length)J="Invalid isSafeLinksEnabledString";else{n.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",H);var Q=e.nCd(H);if(void 0===O.WebAffinitizedUrl||null===O.WebAffinitizedUrl||0>=O.WebAffinitizedUrl.length)J=
"Invalid WebAffinitizedUrl";else if(void 0===O.PolicyCookie||null===O.PolicyCookie||0>=O.PolicyCookie.length)J="Invalid PolicyCookie";else if(void 0===O.PolicyCookieTTL||null===O.PolicyCookieTTL)J="Invalid PolicyCookieTTL";else{var ca=O.WebAffinitizedUrl,X=O.PolicyCookie,Z=O.AffinitizedUrl,ea=new Date;ea.setMinutes(ea.getMinutes()+(5<O.PolicyCookieTTL?O.PolicyCookieTTL-5:0));var ka=ea.getTime(),Y=new m(H,ca,X,ka,!1,Z);this.PXf(Y);K=F.data.httpStatus;this.Iqa&&(Q?(this.V$f(this.Iqa),this.tDa=this.sDa=
0):(n.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),B.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),v.a.UU(this.Iqa)),this.Iqa=null)}}}else J="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(qa){J="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+qa.toString()}finally{K!==G.a.TO&&this.L4e(K,J)}};e.prototype.iWh=function(F){this.zSb=!1;var K=500,J="";try{var O=this.vyc(F.data.state).returnValue,
N=Object.assign(new M.a,{durationMs:O});K=F.data.httpStatus;B.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+K.toString(),!1,!0,N);J="Request Failed, Status="+E.a[F.data.status]+" Duration: "+O}catch(H){J="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+H.toString()}finally{this.L4e(K,J)}};e.prototype.L4e=function(F,K){K=void 0===K?"":K;try{if(n.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",F,K),this.sDa<
this.WTb&&this.tDa<this.XTb)this.Nbc(this.Syb);else{this.Syb=!1;n.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.sDa,this.tDa,F,K);K=null;var J=y.a.Fr();J&&(J.set("HttpStatus",F.toString()),K=Object.assign(new M.a,{extendedProperties:J}));B.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,K);var O=new m("false","","",0,!0,"");this.PXf(O);this.Iqa&&(n.ULS.sendTraceTag(26019603,
378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),B.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),v.a.UU(this.Iqa),this.Iqa=null)}}catch(N){n.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",N.toString())}};e.prototype.V$f=function(F){var K=this.l0e(),J=this.x_h(),O={};O.Url=F;O.SafeLinksCookie=K;O.CorrelationId=U.a.create().toString();O.WorkloadId=this.LXj;O.UserAgentInfo=
I.a.qGa+"|"+this.appName;n.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",O.CorrelationId);v.a.Tpc(v.a.qX(4),J,O)};e.prototype.isSafeLinksEnabledForUser=function(){var F=this.ib.Wa("IsSafeLinksEnabledForUser");return F?e.nCd(F):!1};e.prototype.Vli=function(){var F=this.ib.gw("SafeLinksDisabledBrowsers");if(I.a.LC){if(this.ib.co("SafeLinksForTeamsIsEnabled")&&this.ib.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(F,"Electron"))return!1}else if(Array.contains(F,
I.a.qGa))return!1;return"officecomhwa"===(this.ib.Wa(w.AFrameworkApplication.kea)||"").toLowerCase()?!1:!0};e.prototype.wyj=function(){return-1!==window.location.href.indexOf("&wd_slnh=1")?!0:I.a.LC};e.prototype.oyj=function(){var F=0;var K=this.i3a(),J=K?K.IsSafeLinksEnabled:"";if(""!==J)return K.WasServiceDown?(n.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===J.toLowerCase()?(n.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),
{returnValue:!1,state:1}):{returnValue:e.nCd(J),state:F};if(this.zSb)return F=3,n.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:F};if(this.sDa>=this.WTb||this.tDa>=this.XTb)return F=2,n.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.sDa,this.WTb,this.tDa,this.XTb),{returnValue:!1,state:F};n.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",
this.WTb+this.XTb-(this.sDa+this.tDa));return{returnValue:!0,state:F}};e.prototype.l0e=function(){var F=this.i3a();return F?F.PolicyCookie:""};e.prototype.x_h=function(){var F=this.i3a();return F?F.WebAffinitizedUrl:""};e.prototype.BHh=function(){var F=this.i3a();return F?F.AffinitizedUrl:""};e.prototype.GNh=function(){var F=new Date;try{var K=this.i3a();F.setTime(K?K.PolicyCookieTTL:0)}catch(J){n.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",
J)}return F};e.prototype.Wod=function(){var F=this.GNh();return!!F&&F.getTime()<Date.now()};e.prototype.i3a=function(){if(!this.aWb){var F=x.a.instance.getItem(this.userId);if(!F||""===F)return null;this.aWb=JSON.parse(F)}return this.aWb};e.prototype.PXf=function(F){if(void 0===F||null===F)throw Error.argumentNull("safeLinksData");if(void 0===F.IsSafeLinksEnabled||null===F.IsSafeLinksEnabled||0>=F.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.aWb=F;F.WasServiceDown||
this.TXj(F)};e.prototype.TXj=function(F){F=JSON.stringify(F);x.a.instance.setItem(this.userId,F)};e.prototype.D2c=function(F){return void 0!==e.qh&&null!==e.qh?e.qh.sc("WebServiceCall",F):null};e.prototype.vyc=function(F){if(void 0!==F&&null!==F){var K=F.qc;F.stop();return{returnValue:K,stopwatch:null}}return{returnValue:null,stopwatch:F}};e.nCd=function(F){return"false"!==F.toLowerCase()?!0:!1};Af.Object.defineProperties(e.prototype,{appName:{configurable:!0,enumerable:!0,get:function(){return this.oQb}},
RCc:{configurable:!0,enumerable:!0,get:function(){return this.Ayg}},userId:{configurable:!0,enumerable:!0,get:function(){return this.iyg}},PTh:{configurable:!0,enumerable:!0,get:function(){var F=this.RCc?this.RCc+"/":"",K=new C.QueryStringBuilder("SafeLinksHandler.ashx");K.Ii("app",this.appName);this.ib.ra("SafeLinksUseDebugHeader")&&K.Ii("action","debug");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&K.Ii("s2satpop","1");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",
!1)&&K.Ii("s2saat","1");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&K.Ii("s2se03","1");return String.format("{0}{1}&{2}",F,K.toString(),w.AFrameworkApplication.aj)}},LZh:{configurable:!0,enumerable:!0,get:function(){var F=this.RCc?this.RCc+"/":"",K=new C.QueryStringBuilder("SafeLinksHandler.ashx");K.Ii("app",this.appName);this.ib.ra("SafeLinksUseDebugHeader")&&K.Ii("action","debug");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&K.Ii("s2satpop","1");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&K.Ii("s2saat","1");this.ib.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&K.Ii("s2se03","1");K.Ii("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",F,K.toString(),w.AFrameworkApplication.aj)}},yCi:{configurable:!0,enumerable:!0,get:function(){e.RPc||(e.RPc=new k(this.ib,this.Pg,this.LZh,e.qh));return e.RPc}}});e.qh=null;e.RPc=null;Object(u.a)(e,
"SafeLinksManager",null,[656]);var T=D.a;Rk(a,T);a.prototype.create=function(){this.pb(this.$.da.za(269)||new e(w.AFrameworkApplication.fa,w.AFrameworkApplication.qd,String.format("{0}-{1}",d(w.AFrameworkApplication.ta.Pa.Fj),c(w.AFrameworkApplication.ta.Pa.lca))))};a.ka=function(F){F.da.Ga(270,new a(F))};Object(u.a)(a,"SafeLinksManagerFactory",D.a,[]);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(function(){f.a.Fa(function(F){a.ka(F)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDS.safelinks.js.map/10c3c69639c9fe7680e56ff9a8ca236e/EwaDS.safelinks.js.map